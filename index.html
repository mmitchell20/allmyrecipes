<!-- Replace your existing script with this -->
<script type="module">
  /* 1) Import the parser from your separate file */
  import { parseRecipeText } from './parser-better.js';  /* <- change to './parse-better.js' if that's your filename */

  (function () {
    const $ = (s) => document.querySelector(s);

    const form     = $('#cleaner');
    const titleEl  = $('#title');
    const sourceEl = $('#source');
    const rawEl    = $('#raw');
    const statusEl = $('#status');
    const errorEl  = $('#error');

    /* Title suggestion using the parser’s title guess */
    let titleTouched = false;
    titleEl.addEventListener('input', () => { titleTouched = true; });

    function maybeSuggest() {
      const parsed = parseRecipeText(rawEl.value || '');
      if (!titleTouched && (!titleEl.value || titleEl.value.trim() === '')) {
        if (parsed.title) titleEl.value = parsed.title;
      } else if (parsed.title) {
        titleEl.placeholder = parsed.title;
      }
    }
    rawEl.addEventListener('input', maybeSuggest);
    rawEl.addEventListener('paste', () => setTimeout(maybeSuggest, 0));

    /* Submit -> call parser -> stash -> go to recipe page */
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      errorEl.textContent = '';
      statusEl.textContent = 'Cleaning…';

      try {
        const parsed = parseRecipeText(rawEl.value || '');

        const recipe = {
          id: 'tmp_' + Date.now(),
          title: (titleEl.value.trim() || parsed.title || '').trim(),
          source: sourceEl.value.trim(),
          ingredients: parsed.ingredients || [],
          steps: parsed.steps || [],
          servings: parsed.servings || '',
          createdAt: new Date().toISOString()
        };

        sessionStorage.setItem('amr_tmp', JSON.stringify(recipe));
        statusEl.textContent = 'Done. Opening recipe…';
        window.location.href = 'recipe.html';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '';
        errorEl.textContent = 'Could not clean this text. Try a different format.';
      }
    });
  })();
</script>
